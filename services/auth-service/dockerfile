FROM node:20-slim

RUN apt-get update && apt-get install -y \
    openssl \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy root package files (workspace configuration)
COPY package*.json ./

# Copy workspace packages
COPY Shared_dataBase ./Shared_dataBase
COPY services ./services

# Install ALL workspace dependencies from root
RUN npm install --legacy-peer-deps

# Generate Prisma client
RUN npm run prisma:generate

# Build auth service
WORKDIR /app/services/auth-service

# Install auth service dependencies locally
RUN npm install

# Generate Prisma client for auth service specifically
RUN npm run prisma:generate

# Copy generated client to auth service node_modules
RUN mkdir -p ./node_modules/.prisma && cp -r ../../Shared_dataBase/node_modules/@prisma/client ./node_modules/.prisma/
RUN mkdir -p ./node_modules/@prisma && cp -r ../../Shared_dataBase/node_modules/@prisma/client ./node_modules/@prisma/

RUN npm run build && ls -la dist/ || (echo "Build failed or dist directory not created" && exit 1)

# Setup environment
ENV NODE_ENV=production
ENV DATABASE_URL="file:/app/database/transcendence.db"

RUN mkdir -p /app/database && chmod 755 /app/database

EXPOSE 3010

CMD ["sh", "-c", "cd /app && npm run prisma:migrate:deploy  && cd /app/services/auth-service && npm run prisma:generate  && mkdir -p ./node_modules/.prisma && cp -r ../../Shared_dataBase/node_modules/@prisma/client ./node_modules/.prisma/ && mkdir -p ./node_modules/@prisma && cp -r ../../Shared_dataBase/node_modules/@prisma/client ./node_modules/@prisma/ && echo 'Auth service starting...' && node dist/server.js"]